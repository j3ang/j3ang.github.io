window.__NUXT__=function(e,t,s,n){return{layout:"default",data:[{single:{id:17,date:t,date_gmt:t,guid:{rendered:"http://localhost:3080/?p=17"},modified:s,modified_gmt:s,slug:"concatenating-row-values-by-groups",status:"publish",type:"post",link:"http://localhost:3080/concatenating-row-values-by-groups/",title:{rendered:"Concatenating row values by groups"},content:{rendered:'<p><img src="https://j3ang-uploads.storage.googleapis.com/wp-content/uploads/2021/01/09190524/post-17-5ff9fe5c0dd16.png" alt="usecase_1" /></p>\n<p>TASK USECASES: </p>\n<ol>\n<li>Empty values created due to large chunk of description </li>\n<li>Grouping multiple intersts</li>\n</ol>\n<p>Query User Intersts</p>\n<pre><code>SELECT\n    u.user_email AS &#039;Email&#039;,\n    u.display_name,\n    SUBSTRING_INDEX(u.display_name, &#039; &#039;, 1) AS &#039;First&#039;,\n    SUBSTRING_INDEX(u.display_name, &#039; &#039;, -1) AS &#039;Last&#039;,\n    wp.post_title AS &#039;Company&#039;,\n    mp.meta_value AS &#039;Job Title&#039;,\n    a.name AS &#039;Interets&#039;\nFROM \n    (SELECT id, name\n    FROM posts_terms_authors\n    WHERE posts_terms_authors.taxonomy=&#039;category&#039; ) AS a\nLEFT JOIN \n    (SELECT id, name\n    FROM posts_terms_authors\n    WHERE posts_terms_authors.taxonomy=&#039;author&#039;) AS b\n    ON a.id = b.id\nLEFT JOIN wp_users u ON u.user_login = b.name\nLEFT JOIN wp_usermeta mp ON u.id = mp.user_id\nLEFT JOIN wp_usermeta mc ON u.id = mc.user_id\nLEFT JOIN wp_posts wp ON wp.ID = mc.meta_value\nWHERE mp.meta_key LIKE &#039;position&#039;\n  AND mc.meta_key LIKE &#039;company&#039;;</code></pre>\n<p>Concatenating user intersts</p>\n<pre><code>CREATE OR REPLACE VIEW user_intersts_grouped AS\nSELECT Email,First,Last,\n       Company,&#039;Job Title&#039;,  \n       group_concat( distinct intersts) AS &#039;Intersts&#039; \nFRROM user_intersts\nGROUP BY Email,First,Last,Company, Job Title;</code></pre>\n<p>Get users with no interests</p>\n<pre><code>SELECT * FROM wp_users U \nWHERE U.ID NOT IN (\n    SELECT ID FROM wp_users a\n    JOIN user_intersts_grouped b \n    ON a.user_email = b.Email)</code></pre>\n<p>Check total number of records</p>\n<pre><code>SELECT count(*) FROM ( \n    SELECT u.ID, u.user_email AS &#039;Email&#039;,\n       u.display_name,\n       SUBSTRING_INDEX(u.display_name, &#039; &#039;, 1) AS &#039;First&#039;,\n       SUBSTRING_INDEX(u.display_name, &#039; &#039;, -1) AS &#039;Last&#039;,\n       wp.post_title AS &#039;Company&#039;,\n       mp.meta_value AS &#039;Job Title&#039;\n    FROM  wp_users u\n    LEFT JOIN wp_usermeta mp ON u.id = mp.user_id\n    LEFT JOIN wp_usermeta mc ON u.id = mc.user_id\n    LEFT JOIN wp_posts wp ON wp.ID = mc.meta_value\n    WHERE mp.meta_key like &#039;position&#039; and mc.meta_key like &#039;company&#039;\n    AND u.ID NOT IN (SELECT ID FROM wp_users a\n    JOIN user_intersts_grouped b ON a.user_email = b.Email)) T;</code></pre>\n<p>Create view from final table</p>\n<pre><code>CREATE OR REPLACE VIEW users_with_no_interetsts AS\nSELECT u.user_email AS &#039;Email&#039;,\n       SUBSTRING_INDEX(u.display_name, &#039; &#039;, 1) AS &#039;First&#039;,\n       SUBSTRING_INDEX(u.display_name, &#039; &#039;, -1) AS &#039;Last&#039;,\n       wp.post_title AS &#039;Company&#039;,\n       mp.meta_value AS &#039;Job Title&#039;\nFROM  wp_users u\nLEFT JOIN wp_usermeta mp ON u.id = mp.user_id\nLEFT JOIN wp_usermeta mc ON u.id = mc.user_id\nLEFT JOIN wp_posts wp ON wp.ID = mc.meta_value\nWHERE mp.meta_key like &#039;position&#039; and mc.meta_key like &#039;company&#039;\nAND u.ID NOT IN (SELECT ID FROM wp_users a\nJOIN user_interests_grouped b ON a.user_email = b.Email)</code></pre>\n<p>Switched to user and select all the categories  categories:</p>\n<pre><code>a:10:{\ni:0;s:2:&quot;56&quot;;\ni:1;s:2:&quot;24&quot;;\ni:2;s:2:&quot;43&quot;;\ni:3;s:2:&quot;23&quot;;\ni:4;s:2:&quot;40&quot;;\ni:5;s:2:&quot;37&quot;;\ni:6;s:2:&quot;52&quot;;\ni:7;s:3:&quot;185&quot;;\ni:8;s:2:&quot;54&quot;;\ni:9;s:2:&quot;38&quot;;}</code></pre>\n<pre><code>CREATE OR REPLACE VIEW categories AS\nSELECT * FROM wp_terms WHERE term_id IN (56,24,43,23,40,37,52,185,54,38)\nORDER BY name;</code></pre>\n<p>Finally populating user interests<br />\n(in case views got deleted or not exist on staging/prod, the injection query will use the full sub query. )</p>\n<pre><code>global $wpdb;\n$sql=&quot;select t.ID, GROUP_CONCAT(DISTINCT catagory) AS &#039;Interests&#039; FROM( SELECT u.ID, c.term_id AS catagory FROM ( select u.user_email as &#039;Email&#039;, u.display_name, SUBSTRING_INDEX(u.display_name, &#039; &#039;, 1) as &#039;First&#039;, SUBSTRING_INDEX(u.display_name, &#039; &#039;, -1) as &#039;Last&#039;, wp.post_title as &#039;Company&#039;, mp.meta_value as &#039;Job Title&#039;, a.name as &#039;Interets&#039; from ( select id, name from posts_terms_authors where posts_terms_authors.taxonomy=&#039;category&#039;) as a left join (select id, name from posts_terms_authors where posts_terms_authors.taxonomy=&#039;author&#039;) as b on a.id = b.id left join wp_users u on u.user_login = b.name left join wp_usermeta mp on u.id = mp.user_id left join wp_usermeta mc on u.id = mc.user_id left join wp_posts wp on wp.ID = mc.meta_value where mp.meta_key like &#039;position&#039; and mc.meta_key like &#039;company&#039; and a.name !=&#039;Uncategorized&#039; ) i JOIN categories c ON i.Interets = c.name LEFT JOIN wp_users u ON u.display_name = i.display_name ) t GROUP BY t.ID;&quot;;\n$results = $wpdb-&gt;get_results($sql);\n\nforeach ( $results as $result ) {\n    update_user_meta( $result-&gt;ID, &#039;profile_interests&#039;, explode(&#039;,&#039;, $result-&gt;Interests) );\n}</code></pre>\n<p>It\'s probably better to convert to procedure...</p>\n',protected:!1},excerpt:{rendered:"<p>TASK USECASES: Empty values created due to large chunk of description Grouping multiple intersts Query User Intersts SELECT u.user_email AS &#039;Email&#039;, u.display_name, SUBSTRING_INDEX(u.display_name, &#039; &#039;, 1) AS &#039;First&#039;, SUBSTRING_INDEX(u.display_name, &#039; &#039;, -1) AS &#039;Last&#039;, wp.post_title AS &#039;Company&#039;, mp.meta_value AS &#039;Job Title&#039;, a.name AS &#039;Interets&#039; FROM (SELECT id, name FROM posts_terms_authors WHERE posts_terms_authors.taxonomy=&#039;category&#039; ) AS a [&hellip;]</p>\n",protected:!1},author:1,featured_media:0,comment_status:n,ping_status:n,sticky:!1,template:"",format:"standard",meta:[],categories:[9],tags:[12,10],_links:{self:[{href:"http://localhost:3080/wp-json/wp/v2/posts/17"}],collection:[{href:"http://localhost:3080/wp-json/wp/v2/posts"}],about:[{href:"http://localhost:3080/wp-json/wp/v2/types/post"}],author:[{embeddable:e,href:"http://localhost:3080/wp-json/wp/v2/users/1"}],replies:[{embeddable:e,href:"http://localhost:3080/wp-json/wp/v2/comments?post=17"}],"version-history":[{count:5,href:"http://localhost:3080/wp-json/wp/v2/posts/17/revisions"}],"predecessor-version":[{id:33,href:"http://localhost:3080/wp-json/wp/v2/posts/17/revisions/33"}],"wp:attachment":[{href:"http://localhost:3080/wp-json/wp/v2/media?parent=17"}],"wp:term":[{taxonomy:"category",embeddable:e,href:"http://localhost:3080/wp-json/wp/v2/categories?post=17"},{taxonomy:"post_tag",embeddable:e,href:"http://localhost:3080/wp-json/wp/v2/tags?post=17"}],curies:[{name:"wp",href:"https://api.w.org/{rel}",templated:e}]}}}],fetch:[],error:null,serverRendered:e,routePath:"/concatenating-row-values-by-groups",config:{content:{dbHash:"b25b294c"}}}}(!0,"2021-01-09T06:50:55","2021-01-09T19:08:05","open")